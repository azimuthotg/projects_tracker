<?xml version="1.0" encoding="UTF-8"?>
<!--
    IIS Reverse Proxy — Path-based routing สำหรับ lib.npu.ac.th
    ════════════════════════════════════════════════════════════
    วางไฟล์นี้ที่: C:\iis_root\web.config
    (C:\iis_root\ คือ Physical Path ของ IIS Site)

    การทำงาน:
      https://lib.npu.ac.th/projects/*  →  ตัด /projects  →  127.0.0.1:8000
      https://lib.npu.ac.th/app2/*      →  ตัด /app2      →  127.0.0.1:8001
      https://lib.npu.ac.th/app3/*      →  ตัด /app3      →  127.0.0.1:8002

    ต้องการ: IIS + ARR (Application Request Routing) + URL Rewrite modules
-->
<configuration>
    <system.webServer>

        <defaultDocument enabled="false" />
        <directoryBrowse enabled="false" />

        <httpProtocol>
            <customHeaders>
                <remove name="X-Powered-By" />
            </customHeaders>
        </httpProtocol>

        <rewrite>
            <rules>

                <!-- ══════════════════════════════════════════════
                     Rule 0: Redirect HTTP → HTTPS (ทุก request)
                     ══════════════════════════════════════════════ -->
                <rule name="Force HTTPS" stopProcessing="true">
                    <match url="(.*)" />
                    <conditions>
                        <add input="{HTTPS}" pattern="^OFF$" />
                    </conditions>
                    <action type="Redirect"
                            url="https://{HTTP_HOST}/{R:1}"
                            redirectType="Permanent" />
                </rule>

                <!-- ══════════════════════════════════════════════
                     App 1: Project Tracker
                     /projects  →  127.0.0.1:8000
                     ══════════════════════════════════════════════ -->

                <!-- /projects (ไม่มี trailing slash) → redirect ไป /projects/ -->
                <rule name="App1 Root Redirect" stopProcessing="true">
                    <match url="^projects$" />
                    <action type="Redirect" url="/projects/" redirectType="Permanent" />
                </rule>

                <!-- /projects/* → ตัด prefix แล้วส่งให้ Waitress :8000 -->
                <rule name="App1 Project Tracker" stopProcessing="true">
                    <match url="^projects/(.*)" />
                    <serverVariables>
                        <set name="HTTP_X_FORWARDED_PROTO" value="https" />
                        <set name="HTTP_X_REAL_IP" value="{REMOTE_ADDR}" />
                    </serverVariables>
                    <action type="Rewrite" url="http://127.0.0.1:8000/{R:1}" />
                </rule>

                <!-- ══════════════════════════════════════════════
                     App 2: (สำรอง — เปิด comment เมื่อพร้อม)
                     /budget  →  127.0.0.1:8001
                     ══════════════════════════════════════════════ -->
                <!--
                <rule name="App2 Root Redirect" stopProcessing="true">
                    <match url="^budget$" />
                    <action type="Redirect" url="/budget/" redirectType="Permanent" />
                </rule>
                <rule name="App2 Budget" stopProcessing="true">
                    <match url="^budget/(.*)" />
                    <serverVariables>
                        <set name="HTTP_X_FORWARDED_PROTO" value="https" />
                        <set name="HTTP_X_REAL_IP" value="{REMOTE_ADDR}" />
                    </serverVariables>
                    <action type="Rewrite" url="http://127.0.0.1:8001/{R:1}" />
                </rule>
                -->

                <!-- ══════════════════════════════════════════════
                     App 3: (สำรอง — เปิด comment เมื่อพร้อม)
                     /hr  →  127.0.0.1:8002
                     ══════════════════════════════════════════════ -->
                <!--
                <rule name="App3 Root Redirect" stopProcessing="true">
                    <match url="^hr$" />
                    <action type="Redirect" url="/hr/" redirectType="Permanent" />
                </rule>
                <rule name="App3 HR" stopProcessing="true">
                    <match url="^hr/(.*)" />
                    <serverVariables>
                        <set name="HTTP_X_FORWARDED_PROTO" value="https" />
                        <set name="HTTP_X_REAL_IP" value="{REMOTE_ADDR}" />
                    </serverVariables>
                    <action type="Rewrite" url="http://127.0.0.1:8002/{R:1}" />
                </rule>
                -->

            </rules>
        </rewrite>

        <security>
            <requestFiltering>
                <!-- อนุญาต upload สูงสุด 20MB -->
                <requestLimits maxAllowedContentLength="20971520" />
            </requestFiltering>
        </security>

    </system.webServer>
</configuration>
